### Dependencies
- node 16 (for converting postman files to k6 tests)
- k6 https://k6.io/docs/getting-started/installation (for running tests)

### Developer Setup
- `npm install` (only necessary if you are updating the postman tests)
- install k6: https://k6.io/docs/getting-started/installation

### Workflow
1. update postman collection / env
2. export postman collection / env to legal-api/tests/performance/postman folder as required
3. convert to k6 test file `npm run convert:postman`.  Note: code autogeneration may require some tweaks.  See developer notes
   for more details.
4. update converted file as needed (you may need to copy paste the info in the terminal into the desired test file).
5. run the test `k6 run load_business_flow.js`
6. review results to determine if required performance test thresholds were met


### Developer notes
The auto-generated javascript will likely require updates to define the specific performance thresholds and test
scenarios that we want to simulate.  For example, the `business_flow_test.js` defines this as follows:

``` javascript
export let options = {
  // NB: stages used for ramp-up load testing
  stages: [
    // { duration: '5m', target: 10 }, // simulate ramp-up of traffic from 1 to 10 users over 5 minutes.
    // { duration: '5m', target: 10 }, // stay at 10 users for 5 minutes
    // { duration: '3m', target: 30 }, // ramp-up to 30 users over 3 minutes
    // { duration: '5m', target: 30 }, // stay at 30 users for 5 minutes
    // { duration: '3m', target: 50 }, // ramp-up to 50 users over 3 minutes (peak hour starts)
    // { duration: '10m', target: 50 }, // stay at 50 users for an amount of time (peak hour)
    // { duration: '3m', target: 30 }, // ramp-down to 30 users over 3 minutes (peak hour ends)
    // { duration: '5m', target: 30 }, // continue at 30 for additional 5 minutes
    // { duration: '3m', target: 10 }, // ramp-down to 10 users over 3 minutes
    // { duration: '3m', target: 10 }, // continue at 10 for additional 3 minutes
    // { duration: '5m', target: 0 }, // ramp-down to 0 users
  ],
  duration: '1m', // comment out when using stages
  vus: 2, // comment out when using stages
  thresholds: {
    http_req_failed: ['rate<0.01'],
    http_req_duration: ['p(95)<1000'],
  },
};
```

The autogeneration of javascript via `npm run convert:postman` is not always usable as is.  For example, for the
authentication call, the following code snippet had to be modified:

**before modification of autogenerated code**
``` javascript
group("auth", function() {
 postman[Request]({
   name: "authenticate",
   id: "001e502c-986c-4f7a-86b7-a9df20653e50",
   method: "POST",
   ...
   auth(config, Var) {
     const address = new URI(config.address);
     address.username(`${pm[Var]("client_id")}`);
     address.password(`${pm[Var]("client_secret")}`);
     config.address = address.toString();
     config.options.auth = "basic";
   }
 });
});
```

**after modification of autogenerated code**
``` javascript
import encoding from 'k6/encoding';   

group("auth", function() {
 postman[Request]({
   name: "authenticate",
   id: "001e502c-986c-4f7a-86b7-a9df20653e50",
   method: "POST",
   ...
   auth(config, Var) {
     const encodedAuth = encoding.b64encode(`${pm[Var]("client_id")}:${pm[Var]("client_secret")}`)
     config.headers.Authorization = `Basic ${encodedAuth}`
   }
 });
});
```

### Devops notes
If you upgrade the libs folder please note that inside `libs/shim/core.js` we needed to update the fn `executeRequest` with
```
// remove unwanted saved options
delete setting.options.headers
```
before returning the response to prevent the headers of each request overwriting future request headers.



